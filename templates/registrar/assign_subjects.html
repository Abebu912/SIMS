{% extends 'base.html' %}
{% block title %}Assign Subjects - Registrar{% endblock %}
{% block content %}
<div class="container py-4">
  <h3>Assign Subjects to Teacher</h3>
  <p class="text-muted">Select a teacher and assign subjects by grade level / term.</p>

  <form method="get" class="row g-2 mb-3">
    <div class="col-auto">
      <input type="number" name="grade_level" class="form-control" placeholder="Grade level" min="1" max="12" value="{{ filter_grade_level }}">
    </div>
    <div class="col-auto">
      <input type="text" name="academic_year" class="form-control" placeholder="Academic year (e.g. 2025-2026)" value="{{ filter_academic_year }}">
    </div>
    <div class="col-auto">
      <select name="semester" class="form-select">
        <option value="">-- Semester (optional) --</option>
        <option value="first" {% if filter_semester == 'first' %}selected{% endif %}>First</option>
        <option value="second" {% if filter_semester == 'second' %}selected{% endif %}>Second</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-secondary">Filter</button>
    </div>
  </form>

  <form method="post" id="assign-form">
    {% csrf_token %}
    <div class="row">
      <div class="col-md-4">
        <label class="form-label">Select Teacher</label>
        <select name="teacher_user_id" class="form-select" required>
          <option value="">-- Choose Teacher --</option>
          {% for t in teachers %}
            <option value="{{ t.id }}">{{ t.get_full_name|default:t.username }}</option>
          {% endfor %}
        </select>
        <div class="mt-2">
          <label class="form-label small">Academic Year <span class="text-danger">*</span></label>
          <input type="text" name="academic_year" class="form-control" placeholder="e.g. 2025-2026" required value="{{ filter_academic_year }}">
        </div>
        <div class="mt-2">
          <label class="form-label small">Semester <span class="text-danger">*</span></label>
          <select name="semester" class="form-select" required>
            <option value="">-- Select Semester --</option>
            <option value="first" {% if filter_semester == 'first' %}selected{% endif %}>First</option>
            <option value="second" {% if filter_semester == 'second' %}selected{% endif %}>Second</option>
          </select>
        </div>
      </div>
      <div class="col-md-8">
        <label class="form-label">Available Subjects</label>
        <div class="list-group mb-2" id="available-subjects">
          {% for s in available_subjects %}
            <label class="list-group-item" data-subject-id="{{ s.id }}">
              <input type="checkbox" name="subject_ids" value="{{ s.id }}" class="form-check-input me-2 subject-checkbox"> <strong>{{ s.code }}</strong> - {{ s.name }} <span class="text-muted">(Grade {{ s.grade_level }})</span>
            </label>
          {% empty %}
            <div class="list-group-item">No available subjects for the selected filters.</div>
          {% endfor %}
        </div>
        <hr />
        <label class="form-label">Currently Assigned Subjects</label>
        <div class="list-group mb-2" id="assigned-subjects">
          {% for s in assigned_subjects %}
            <div class="list-group-item d-flex justify-content-between align-items-center assigned-item" data-subject-id="{{ s.id }}">
              <div>
                <strong>{{ s.code }}</strong> - {{ s.name }} <span class="text-muted">(Grade {{ s.grade_level }})</span>
                <div class="small text-muted">Instructor: {{ s.instructor.user.get_full_name|default:s.instructor.user.username }}</div>
              </div>
              <div>
                <form method="post" action="{% url 'unassign_subject_from_teacher' s.id %}" class="unassign-form">
                  {% csrf_token %}
                  <button type="button" class="btn btn-sm btn-outline-danger unassign-btn" data-subject-id="{{ s.id }}">Unassign</button>
                </form>
              </div>
            </div>
          {% empty %}
            <div class="list-group-item">No subjects are currently assigned for the selected filters.</div>
          {% endfor %}
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" name="assign_all" value="1" id="assign_all">
          <label class="form-check-label" for="assign_all">Assign all available subjects (ignore individual selection)</label>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-primary" id="assign-submit">Assign Selected Subjects</button>
      <a href="{% url 'registrar_dashboard' %}" class="btn btn-outline-secondary ms-2">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper to get CSRF token from the page
function getCSRFToken() {
  const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
  return el ? el.value : '';
}

// The assign form now performs a normal POST (non-AJAX) so the registrar
// success message will be displayed on the dashboard. AJAX handling was
// removed to simplify the flow and avoid JS-related failures.

// Delegate clicks on unassign buttons
document.addEventListener('click', function(e){
  const btn = e.target.closest('.unassign-btn');
  if(!btn) return;
  const subjectId = btn.getAttribute('data-subject-id');
  if(!subjectId) return;
  if(!confirm('Unassign this subject from the teacher?')) return;

  const url = '{% url "unassign_subject_from_teacher" 0 %}'.replace('/0/', '/' + subjectId + '/');
  fetch(url, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: ''
  }).then(r => r.json())
  .then(data => {
    if(data.success) {
      // remove assigned item from DOM
      const item = document.querySelector('.assigned-item[data-subject-id="'+subjectId+'"]');
      if(item) item.remove();
      alert('Unassigned ' + (data.code || '') + ' - ' + (data.name || ''));
    } else {
      alert('Unassign failed');
    }
  }).catch(err => {
    console.error(err);
    alert('Error while unassigning');
  });
});

// Fallback: ensure assign button submits the form if nothing else does
(function(){
  try{
    const assignBtn = document.getElementById('assign-submit');
    const assignForm = document.getElementById('assign-form');
    if(assignBtn && assignForm){
      assignBtn.addEventListener('click', function(e){
        // Basic client-side validation to mirror server requirements
        const teacher = assignForm.querySelector('select[name="teacher_user_id"]');
        const year = assignForm.querySelector('input[name="academic_year"]');
        const sem = assignForm.querySelector('select[name="semester"]');
        if(teacher && !teacher.value){
          e.preventDefault();
          alert('Please select a teacher to assign.');
          teacher.focus();
          return;
        }
        if(year && !year.value){
          e.preventDefault();
          alert('Please enter the academic year.');
          year.focus();
          return;
        }
        if(sem && !sem.value){
          e.preventDefault();
          alert('Please select a semester.');
          sem.focus();
          return;
        }

        // If the button is inside the form and default wasn't prevented elsewhere,
        // the form will submit naturally. To be safe, call submit().
        // Use a tiny timeout to allow any other click handlers to run first.
        setTimeout(()=>{
          try{ assignForm.submit(); }catch(err){ console.error('Submit failed', err); }
        }, 10);
      });
    }
  }catch(ex){ console.error('Assign fallback handler error', ex); }
})();
</script>
{% endblock %}
